name: Release

on:
  push:
    tags:
      - "v*"
      - "*-v*" # Per-mod tags like "cyberpunk-v1.0.0"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      # Build Cyberpunk (pure Rust)
      - name: Build Cyberpunk
        run: cargo build -p ctd-cyberpunk --release

      # Build Skyrim (CMake + Rust hybrid)
      - name: Build Skyrim - Rust
        working-directory: mods/skyrim
        run: cargo build --release --target x86_64-pc-windows-msvc --target-dir build/rust-build

      - name: Build Skyrim - CMake
        working-directory: mods/skyrim
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      # Package for Nexus
      - name: Package Nexus releases
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path dist

          # === Cyberpunk Nexus Package ===
          if (Test-Path "target/release/ctd_cyberpunk.dll") {
            $cyberpunkDir = "dist/cyberpunk-nexus"

            # RED4ext structure
            New-Item -ItemType Directory -Force -Path "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk"
            Copy-Item "target/release/ctd_cyberpunk.dll" "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk/"

            # Config file
            @"
# CTD (Crash to Desktop Reporter) Configuration
[api]
url = "https://ctd.ezmode.games"
crashes_path = "/crashes"
timeout_secs = 30
"@ | Out-File -FilePath "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk/ctd.toml" -Encoding UTF8

            # FOMOD installer
            New-Item -ItemType Directory -Force -Path "$cyberpunkDir/fomod"
            @"
<?xml version="1.0" encoding="UTF-8"?>
<fomod>
    <Name>CTD - Crash to Desktop Reporter</Name>
    <Author>ezmode.games</Author>
    <Version>$version</Version>
    <Website>https://github.com/ezmode-games/ctd</Website>
    <Description>Captures crash information and submits it to a crash reporting service.</Description>
</fomod>
"@ | Out-File -FilePath "$cyberpunkDir/fomod/info.xml" -Encoding UTF8

            @"
<?xml version="1.0" encoding="UTF-8"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://qconsulting.ca/fo3/ModConfig5.0.xsd">
    <moduleName>CTD - Crash to Desktop Reporter</moduleName>
    <requiredInstallFiles>
        <folder source="red4ext" destination="red4ext" />
    </requiredInstallFiles>
</config>
"@ | Out-File -FilePath "$cyberpunkDir/fomod/ModuleConfig.xml" -Encoding UTF8

            # README
            @"
CTD - Crash to Desktop Reporter (Cyberpunk 2077)
================================================

Automatically captures crash info and reports it.

REQUIREMENTS: RED4ext

INSTALL: Copy red4ext folder to your Cyberpunk 2077 directory.

CONFIG: Edit red4ext/plugins/ctd-cyberpunk/ctd.toml

https://github.com/ezmode-games/ctd
"@ | Out-File -FilePath "$cyberpunkDir/README.txt" -Encoding UTF8

            Compress-Archive -Path "$cyberpunkDir/*" -DestinationPath "dist/CTD-Cyberpunk-$version.zip"
          }

          # === Skyrim Nexus Package ===
          if (Test-Path "mods/skyrim/build/Release/ctd-skyrim.dll") {
            $skyrimDir = "dist/skyrim-nexus"

            # SKSE structure
            New-Item -ItemType Directory -Force -Path "$skyrimDir/SKSE/Plugins"
            Copy-Item "mods/skyrim/build/Release/ctd-skyrim.dll" "$skyrimDir/SKSE/Plugins/"

            # Config file
            @"
# CTD (Crash to Desktop Reporter) Configuration
[api]
url = "https://ctd.ezmode.games"
crashes_path = "/crashes"
timeout_secs = 30
"@ | Out-File -FilePath "$skyrimDir/SKSE/Plugins/ctd.toml" -Encoding UTF8

            # FOMOD installer
            New-Item -ItemType Directory -Force -Path "$skyrimDir/fomod"
            @"
<?xml version="1.0" encoding="UTF-8"?>
<fomod>
    <Name>CTD - Crash to Desktop Reporter</Name>
    <Author>ezmode.games</Author>
    <Version>$version</Version>
    <Website>https://github.com/ezmode-games/ctd</Website>
    <Description>Captures crash information and submits it to a crash reporting service.</Description>
</fomod>
"@ | Out-File -FilePath "$skyrimDir/fomod/info.xml" -Encoding UTF8

            @"
<?xml version="1.0" encoding="UTF-8"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://qconsulting.ca/fo3/ModConfig5.0.xsd">
    <moduleName>CTD - Crash to Desktop Reporter</moduleName>
    <requiredInstallFiles>
        <folder source="SKSE" destination="SKSE" />
    </requiredInstallFiles>
</config>
"@ | Out-File -FilePath "$skyrimDir/fomod/ModuleConfig.xml" -Encoding UTF8

            # README
            @"
CTD - Crash to Desktop Reporter (Skyrim SE/AE)
==============================================

Automatically captures crash info and reports it.

REQUIREMENTS: SKSE64

INSTALL: Copy SKSE folder to your Skyrim Data directory.

CONFIG: Edit Data/SKSE/Plugins/ctd.toml

https://github.com/ezmode-games/ctd
"@ | Out-File -FilePath "$skyrimDir/README.txt" -Encoding UTF8

            Compress-Archive -Path "$skyrimDir/*" -DestinationPath "dist/CTD-Skyrim-$version.zip"
          }

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
          generate_release_notes: true
