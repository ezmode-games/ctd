name: Release

on:
  push:
    tags:
      - "v*"
      - "*-v*" # Per-mod tags like "cyberpunk-v1.0.0"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      # Build Cyberpunk (pure Rust)
      - name: Build Cyberpunk
        run: cargo build -p ctd-cyberpunk --release

      # Build Skyrim (CMake + Rust hybrid)
      - name: Build Skyrim - Rust
        working-directory: mods/skyrim
        run: cargo build --release --target x86_64-pc-windows-msvc --target-dir build/rust-build

      - name: Build Skyrim - CMake
        working-directory: mods/skyrim
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      # Package for Nexus
      - name: Package Cyberpunk
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path dist

          if (Test-Path "target/release/ctd_cyberpunk.dll") {
            $cyberpunkDir = "dist/cyberpunk-nexus"

            New-Item -ItemType Directory -Force -Path "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk"
            Copy-Item "target/release/ctd_cyberpunk.dll" "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk/"

            # Config file
            $configContent = "# CTD (Crash to Desktop Reporter) Configuration`n"
            $configContent += "[api]`n"
            $configContent += "url = `"https://ctd.ezmode.games`"`n"
            $configContent += "crashes_path = `"/crashes`"`n"
            $configContent += "timeout_secs = 30`n"
            Set-Content -Path "$cyberpunkDir/red4ext/plugins/ctd-cyberpunk/ctd.toml" -Value $configContent -Encoding UTF8

            # FOMOD
            New-Item -ItemType Directory -Force -Path "$cyberpunkDir/fomod"
            $infoXml = "<?xml version=`"1.0`" encoding=`"UTF-8`"?>`n<fomod>`n  <Name>CTD - Crash to Desktop Reporter</Name>`n  <Author>ezmode.games</Author>`n  <Version>$version</Version>`n  <Website>https://github.com/ezmode-games/ctd</Website>`n</fomod>"
            Set-Content -Path "$cyberpunkDir/fomod/info.xml" -Value $infoXml -Encoding UTF8

            $moduleXml = "<?xml version=`"1.0`" encoding=`"UTF-8`"?>`n<config xmlns:xsi=`"http://www.w3.org/2001/XMLSchema-instance`"><moduleName>CTD</moduleName><requiredInstallFiles><folder source=`"red4ext`" destination=`"red4ext`"/></requiredInstallFiles></config>"
            Set-Content -Path "$cyberpunkDir/fomod/ModuleConfig.xml" -Value $moduleXml -Encoding UTF8

            Set-Content -Path "$cyberpunkDir/README.txt" -Value "CTD - Crash to Desktop Reporter`nRequires RED4ext`nhttps://github.com/ezmode-games/ctd" -Encoding UTF8

            Compress-Archive -Path "$cyberpunkDir/*" -DestinationPath "dist/CTD-Cyberpunk-$version.zip"
          }

      - name: Package Skyrim
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"

          if (Test-Path "mods/skyrim/build/Release/ctd-skyrim.dll") {
            $skyrimDir = "dist/skyrim-nexus"

            New-Item -ItemType Directory -Force -Path "$skyrimDir/SKSE/Plugins"
            Copy-Item "mods/skyrim/build/Release/ctd-skyrim.dll" "$skyrimDir/SKSE/Plugins/"

            # Config file
            $configContent = "# CTD (Crash to Desktop Reporter) Configuration`n"
            $configContent += "[api]`n"
            $configContent += "url = `"https://ctd.ezmode.games`"`n"
            $configContent += "crashes_path = `"/crashes`"`n"
            $configContent += "timeout_secs = 30`n"
            Set-Content -Path "$skyrimDir/SKSE/Plugins/ctd.toml" -Value $configContent -Encoding UTF8

            # FOMOD
            New-Item -ItemType Directory -Force -Path "$skyrimDir/fomod"
            $infoXml = "<?xml version=`"1.0`" encoding=`"UTF-8`"?>`n<fomod>`n  <Name>CTD - Crash to Desktop Reporter</Name>`n  <Author>ezmode.games</Author>`n  <Version>$version</Version>`n  <Website>https://github.com/ezmode-games/ctd</Website>`n</fomod>"
            Set-Content -Path "$skyrimDir/fomod/info.xml" -Value $infoXml -Encoding UTF8

            $moduleXml = "<?xml version=`"1.0`" encoding=`"UTF-8`"?>`n<config xmlns:xsi=`"http://www.w3.org/2001/XMLSchema-instance`"><moduleName>CTD</moduleName><requiredInstallFiles><folder source=`"SKSE`" destination=`"SKSE`"/></requiredInstallFiles></config>"
            Set-Content -Path "$skyrimDir/fomod/ModuleConfig.xml" -Value $moduleXml -Encoding UTF8

            Set-Content -Path "$skyrimDir/README.txt" -Value "CTD - Crash to Desktop Reporter`nRequires SKSE64`nhttps://github.com/ezmode-games/ctd" -Encoding UTF8

            Compress-Archive -Path "$skyrimDir/*" -DestinationPath "dist/CTD-Skyrim-$version.zip"
          }

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
          generate_release_notes: true
