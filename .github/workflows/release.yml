name: Release

on:
  push:
    tags:
      # Per-mod tags: <mod>-v<version> (e.g., skyrim-v1.0.0, ue5-v0.2.1)
      - '*-v[0-9]*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  parse-tag:
    name: Parse Tag
    runs-on: ubuntu-latest
    outputs:
      mod_name: ${{ steps.parse.outputs.mod_name }}
      version: ${{ steps.parse.outputs.version }}
      build_type: ${{ steps.parse.outputs.build_type }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse tag and determine build type
        id: parse
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Processing tag: $TAG"

          # Extract mod name and version (e.g., skyrim-v1.0.0 -> skyrim, 1.0.0)
          MOD_NAME=$(echo "$TAG" | sed -E 's/-v[0-9].*//')
          VERSION=$(echo "$TAG" | sed -E 's/.*-v//')

          echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Validate mod exists
          if [ ! -d "mods/$MOD_NAME" ]; then
            echo "::error::Mod directory mods/$MOD_NAME does not exist"
            exit 1
          fi

          # Determine build type from CMakeLists.txt presence
          if [ -f "mods/$MOD_NAME/CMakeLists.txt" ]; then
            echo "build_type=cmake" >> $GITHUB_OUTPUT
            echo "Build type: cmake (manual upload required)"
          else
            echo "build_type=cargo" >> $GITHUB_OUTPUT
            echo "Build type: cargo (will build automatically)"
          fi

  build:
    name: Build ${{ needs.parse-tag.outputs.mod_name }}
    needs: parse-tag
    if: needs.parse-tag.outputs.build_type == 'cargo'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Parse nexus.toml config
        id: config
        shell: pwsh
        run: |
          $mod = "${{ needs.parse-tag.outputs.mod_name }}"
          $nexusPath = "mods/$mod/nexus.toml"

          # Defaults
          $arch = "x64"
          $rustTarget = "x86_64-pc-windows-msvc"
          $pluginPath = "plugins"
          $scriptExtender = "Unknown"

          if (Test-Path $nexusPath) {
            $config = Get-Content $nexusPath -Raw

            if ($config -match 'arch\s*=\s*"x86"') {
              $arch = "Win32"
              $rustTarget = "i686-pc-windows-msvc"
            }

            if ($config -match 'plugin_path\s*=\s*"([^"]+)"') {
              $pluginPath = $matches[1]
            }

            if ($config -match 'script_extender\s*=\s*"([^"]+)"') {
              $scriptExtender = $matches[1]
            }
          }

          echo "arch=$arch" >> $env:GITHUB_OUTPUT
          echo "rust_target=$rustTarget" >> $env:GITHUB_OUTPUT
          echo "plugin_path=$pluginPath" >> $env:GITHUB_OUTPUT
          echo "script_extender=$scriptExtender" >> $env:GITHUB_OUTPUT

      - name: Build
        run: |
          cargo build -p ctd-${{ needs.parse-tag.outputs.mod_name }} --release --target ${{ steps.config.outputs.rust_target }}

      - name: Package
        shell: pwsh
        run: |
          $mod = "${{ needs.parse-tag.outputs.mod_name }}"
          $version = "${{ needs.parse-tag.outputs.version }}"
          $target = "${{ steps.config.outputs.rust_target }}"
          $pluginPath = "${{ steps.config.outputs.plugin_path }}"
          $scriptExtender = "${{ steps.config.outputs.script_extender }}"

          # Find the DLL
          $dllName = "ctd_$mod".Replace("-", "_")
          $dllPath = "target/$target/release/$dllName.dll"

          if (-not (Test-Path $dllPath)) {
            # Try alternate naming
            $dllPath = "target/$target/release/ctd-$mod.dll"
          }

          if (-not (Test-Path $dllPath)) {
            Write-Error "DLL not found"
            exit 1
          }

          # Create package structure
          $distDir = "dist/ctd-$mod"
          New-Item -ItemType Directory -Force -Path "$distDir/$pluginPath"
          New-Item -ItemType Directory -Force -Path "$distDir/fomod"

          # Copy DLL
          Copy-Item $dllPath "$distDir/$pluginPath/ctd-$mod.dll"

          # Create config
          @"
          # CTD (Crash to Desktop Reporter) Configuration
          [api]
          url = "https://ctd.ezmode.games"
          "@ | Set-Content "$distDir/$pluginPath/ctd.toml" -Encoding UTF8

          # FOMOD info.xml
          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <fomod>
            <Name>CTD - Crash Reporter ($mod)</Name>
            <Author>ezmode.games</Author>
            <Version>$version</Version>
            <Website>https://github.com/ezmode-games/ctd</Website>
          </fomod>
          "@ | Set-Content "$distDir/fomod/info.xml" -Encoding UTF8

          # FOMOD ModuleConfig.xml
          $rootFolder = $pluginPath.Split("/")[0]
          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <moduleName>CTD - $mod</moduleName>
            <requiredInstallFiles>
              <folder source="$rootFolder" destination="$rootFolder"/>
            </requiredInstallFiles>
          </config>
          "@ | Set-Content "$distDir/fomod/ModuleConfig.xml" -Encoding UTF8

          # README
          @"
          CTD - Crash to Desktop Reporter
          ================================
          Game: $mod
          Version: $version
          Requires: $scriptExtender

          https://github.com/ezmode-games/ctd
          "@ | Set-Content "$distDir/README.txt" -Encoding UTF8

          # Create zip
          $zipName = "ctd-$mod-v$version.zip"
          Compress-Archive -Path "$distDir/*" -DestinationPath "dist/$zipName"
          Write-Host "Created dist/$zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ needs.parse-tag.outputs.mod_name }}
          path: dist/*.zip

  release:
    name: Create Release
    needs: [parse-tag, build]
    if: always() && needs.parse-tag.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.parse-tag.outputs.mod_name }}
          path: artifacts/

      - name: Get mod info
        id: info
        run: |
          MOD="${{ needs.parse-tag.outputs.mod_name }}"

          # Try to get description
          DESC=""
          if [ -f "mods/$MOD/nexus.toml" ]; then
            DESC=$(grep -oP 'description\s*=\s*"\K[^"]+' "mods/$MOD/nexus.toml" 2>/dev/null || true)
          fi
          if [ -z "$DESC" ] && [ -f "mods/$MOD/Cargo.toml" ]; then
            DESC=$(grep -oP 'description\s*=\s*"\K[^"]+' "mods/$MOD/Cargo.toml" 2>/dev/null || true)
          fi

          echo "description=${DESC:-CTD crash reporter for $MOD}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ctd-${{ needs.parse-tag.outputs.mod_name }} v${{ needs.parse-tag.outputs.version }}
          body: |
            ## ${{ steps.info.outputs.description }}

            **Mod:** ctd-${{ needs.parse-tag.outputs.mod_name }}
            **Version:** ${{ needs.parse-tag.outputs.version }}

            ${{ needs.parse-tag.outputs.build_type == 'cargo' && '### Installation
            1. Download the zip file
            2. Extract to your game mod directory (or use your mod manager)
            3. Enable the mod' || '### Note
            This mod requires manual build. Binary will be uploaded separately.

            Build locally with:
            ```
            cd mods/${{ needs.parse-tag.outputs.mod_name }}
            cmake -B build
            cmake --build build --config Release
            ```' }}
          files: artifacts/*.zip
          draft: ${{ needs.parse-tag.outputs.build_type == 'cmake' }}
          generate_release_notes: true
